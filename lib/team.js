'use strict';

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const skygear = require('skygear');
const Bot = require('./bot');
const db = require('./db');
const Survey = require('./survey');

module.exports = class Team {
  constructor(record) {
    this._record = record;
  }

  // create
  static get Record() {
    return skygear.Record.extend('team');
  }

  static create(slackID, token, targetsID) {
    return _asyncToGenerator(function* () {
      const record = yield db.save(new Team.Record({ slackID, token, targetsID }));
      return new Team(record);
    })();
  }

  // read
  get slackID() {
    return this._record['slackID'];
  }

  get token() {
    return this._record['token'];
  }

  get targetsID() {
    return this._record['targetsID'];
  }

  static of(slackID) {
    return _asyncToGenerator(function* () {
      const query = new skygear.Query(Team.Record);
      query.equalTo('slackID', slackID);

      const result = yield db.query(query);
      if (result.length > 1) {
        throw new Error(`Mutiple teams with identical slackID ${slackID} found`);
      }
      return result[0] ? new Team(result[0]) : null;
    })();
  }

  // update
  set token(newValue) {
    this._record['token'] = newValue;
  }

  set targetsID(newValue) {
    this._record['targetsID'] = newValue;
  }

  update() {
    var _this = this;

    return _asyncToGenerator(function* () {
      _this._record = yield db.save(_this._record);
    })();
  }

  // misc
  get bot() {
    return new Bot(this.token);
  }

  get members() {
    return this.bot.fetchUsers();
  }

  get scheduledSurvey() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', this.slackID);
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      if (result.length > 1) {
        throw new Error('Mutiple scheduled survey found');
      }
      return result[0] ? new Survey(result[0]) : null;
    });
  }

  get activeSurvey() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', this.slackID);
    query.equalTo('isSent', true);
    query.equalTo('isClosed', false);
    return db.query(query).then(result => {
      if (result.length > 1) {
        throw new Error('Mutiple active survey found');
      }
      return result[0] ? new Survey(result[0]) : null;
    });
  }

  getSurveys(number) {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', this.slackID);
    query.equalTo('isSent', true);
    query.addDescending('_updated_at');
    query.limit = number;
    return db.query(query).then(result => {
      const surveys = [];
      for (let i = 0; i < result.length; i++) {
        surveys.push(new Survey(result[i]));
      }
      return surveys;
    });
  }

  getAllSurveys() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('teamID', this.slackID);
    query.equalTo('isSent', true);
    query.addDescending('_updated_at');
    return db.query(query).then(result => {
      const surveys = [];
      for (let i = 0; i < result.length; i++) {
        surveys.push(new Survey(result[i]));
      }
      return surveys;
    });
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy90ZWFtLmpzIl0sIm5hbWVzIjpbInNreWdlYXIiLCJyZXF1aXJlIiwiQm90IiwiZGIiLCJTdXJ2ZXkiLCJtb2R1bGUiLCJleHBvcnRzIiwiVGVhbSIsImNvbnN0cnVjdG9yIiwicmVjb3JkIiwiX3JlY29yZCIsIlJlY29yZCIsImV4dGVuZCIsImNyZWF0ZSIsInNsYWNrSUQiLCJ0b2tlbiIsInRhcmdldHNJRCIsInNhdmUiLCJvZiIsInF1ZXJ5IiwiUXVlcnkiLCJlcXVhbFRvIiwicmVzdWx0IiwibGVuZ3RoIiwiRXJyb3IiLCJuZXdWYWx1ZSIsInVwZGF0ZSIsImJvdCIsIm1lbWJlcnMiLCJmZXRjaFVzZXJzIiwic2NoZWR1bGVkU3VydmV5IiwidGhlbiIsImFjdGl2ZVN1cnZleSIsImdldFN1cnZleXMiLCJudW1iZXIiLCJhZGREZXNjZW5kaW5nIiwibGltaXQiLCJzdXJ2ZXlzIiwiaSIsInB1c2giLCJnZXRBbGxTdXJ2ZXlzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsVUFBVUMsUUFBUSxTQUFSLENBQWhCO0FBQ0EsTUFBTUMsTUFBTUQsUUFBUSxPQUFSLENBQVo7QUFDQSxNQUFNRSxLQUFLRixRQUFRLE1BQVIsQ0FBWDtBQUNBLE1BQU1HLFNBQVNILFFBQVEsVUFBUixDQUFmOztBQUVBSSxPQUFPQyxPQUFQLEdBQWlCLE1BQU1DLElBQU4sQ0FBVztBQUMxQkMsY0FBYUMsTUFBYixFQUFxQjtBQUNuQixTQUFLQyxPQUFMLEdBQWVELE1BQWY7QUFDRDs7QUFFRDtBQUNBLGFBQVdFLE1BQVgsR0FBcUI7QUFDbkIsV0FBT1gsUUFBUVcsTUFBUixDQUFlQyxNQUFmLENBQXNCLE1BQXRCLENBQVA7QUFDRDs7QUFFRCxTQUFhQyxNQUFiLENBQXFCQyxPQUFyQixFQUE4QkMsS0FBOUIsRUFBcUNDLFNBQXJDLEVBQWdEO0FBQUE7QUFDOUMsWUFBTVAsU0FBUyxNQUFNTixHQUFHYyxJQUFILENBQVEsSUFBSVYsS0FBS0ksTUFBVCxDQUFnQixF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QUssSUFBSUMsSUFBSSxDQUFiLEVBQWdCQSxJQUFJaEIsT0FBT0MsTUFBM0IsRUFBbUNlLEdBQW5DLEVBQXdDO0FBQ3RDRCxnQkFBUUUsSUFBUixDQUFhLElBQUluQyxNQUFKLENBQVdrQixPQUFPZ0IsQ0FBUCxDQUFYLENBQWI7QUFDRDtBQUNELGFBQU9ELE9BQVA7QUFDRCxLQU5NLENBQVA7QUFPRDtBQWpIeUIsQ0FBNUIiLCJmaWxlIjoidGVhbS5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHNreWdlYXIgPSByZXF1aXJlKCdza3lnZWFyJylcbmNvbnN0IEJvdCA9IHJlcXVpcmUoJy4vYm90JylcbmNvbnN0IGRiID0gcmVxdWlyZSgnLi9kYicpXG5jb25zdCBTdXJ2ZXkgPSByZXF1aXJlKCcuL3N1cnZleScpXG5cbm1vZHVsZS5leHBvcnRzID0gY2xhc3MgVGVhbSB7XG4gIGNvbnN0cnVjdG9yIChyZWNvcmQpIHtcbiAgICB0aGlzLl9yZWNvcmQgPSByZWNvcmRcbiAgfVxuXG4gIC8vIGNyZWF0ZVxuICBzdGF0aWMgZ2V0IFJlY29yZCAoKSB7XG4gICAgcmV0dXJuIHNreWdlYXIuUmVjb3JkLmV4dGVuZCgndGVhbScpXG4gIH1cblxuICBzdGF0aWMgYXN5bmMgY3JlYXRlIChzbGFja0lELCB0b2tlbiwgdGFyZ2V0c0lEKSB7XG4gICAgY29uc3QgcmVjb3JkID0gYXdhaXQgZGIuc2F2ZShuZXcgVGVhbS5SZWNvcmQoeyBzbGFja0lELCB0b2tlbiwgdGFyZ2V0c0lEIH0pKVxuICAgIHJldHVybiBuZXcgVGVhbShyZWNvcmQpXG4gIH1cblxuICAvLyByZWFkXG4gIGdldCBzbGFja0lEICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydzbGFja0lEJ11cbiAgfVxuXG4gIGdldCB0b2tlbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsndG9rZW4nXVxuICB9XG5cbiAgZ2V0IHRhcmdldHNJRCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsndGFyZ2V0c0lEJ11cbiAgfVxuXG4gIHN0YXRpYyBhc3luYyBvZiAoc2xhY2tJRCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoVGVhbS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnc2xhY2tJRCcsIHNsYWNrSUQpXG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYi5xdWVyeShxdWVyeSlcbiAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDEpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgTXV0aXBsZSB0ZWFtcyB3aXRoIGlkZW50aWNhbCBzbGFja0lEICR7c2xhY2tJRH0gZm91bmRgKVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0WzBdID8gbmV3IFRlYW0ocmVzdWx0WzBdKSA6IG51bGxcbiAgfVxuXG4gIC8vIHVwZGF0ZVxuICBzZXQgdG9rZW4gKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWyd0b2tlbiddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHNldCB0YXJnZXRzSUQgKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWyd0YXJnZXRzSUQnXSA9IG5ld1ZhbHVlXG4gIH1cblxuICBhc3luYyB1cGRhdGUgKCkge1xuICAgIHRoaXMuX3JlY29yZCA9IGF3YWl0IGRiLnNhdmUodGhpcy5fcmVjb3JkKVxuICB9XG5cbiAgLy8gbWlzY1xuICBnZXQgYm90ICgpIHtcbiAgICByZXR1cm4gbmV3IEJvdCh0aGlzLnRva2VuKVxuICB9XG5cbiAgZ2V0IG1lbWJlcnMgKCkge1xuICAgIHJldHVybiB0aGlzLmJvdC5mZXRjaFVzZXJzKClcbiAgfVxuXG4gIGdldCBzY2hlZHVsZWRTdXJ2ZXkgKCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoU3VydmV5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCd0ZWFtSUQnLCB0aGlzLnNsYWNrSUQpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNTZW50JywgZmFsc2UpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNdXRpcGxlIHNjaGVkdWxlZCBzdXJ2ZXkgZm91bmQnKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdFswXSA/IG5ldyBTdXJ2ZXkocmVzdWx0WzBdKSA6IG51bGxcbiAgICB9KVxuICB9XG5cbiAgZ2V0IGFjdGl2ZVN1cnZleSAoKSB7XG4gICAgY29uc3QgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ3RlYW1JRCcsIHRoaXMuc2xhY2tJRClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCB0cnVlKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2lzQ2xvc2VkJywgZmFsc2UpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBpZiAocmVzdWx0Lmxlbmd0aCA+IDEpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdNdXRpcGxlIGFjdGl2ZSBzdXJ2ZXkgZm91bmQnKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3VsdFswXSA/IG5ldyBTdXJ2ZXkocmVzdWx0WzBdKSA6IG51bGxcbiAgICB9KVxuICB9XG5cbiAgZ2V0U3VydmV5cyAobnVtYmVyKSB7XG4gICAgY29uc3QgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ3RlYW1JRCcsIHRoaXMuc2xhY2tJRClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCB0cnVlKVxuICAgIHF1ZXJ5LmFkZERlc2NlbmRpbmcoJ191cGRhdGVkX2F0JylcbiAgICBxdWVyeS5saW1pdCA9IG51bWJlclxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgY29uc3Qgc3VydmV5cyA9IFtdXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICBzdXJ2ZXlzLnB1c2gobmV3IFN1cnZleShyZXN1bHRbaV0pKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHN1cnZleXNcbiAgICB9KVxuICB9XG5cbiAgZ2V0QWxsU3VydmV5cyAoKSB7XG4gICAgY29uc3QgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ3RlYW1JRCcsIHRoaXMuc2xhY2tJRClcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCB0cnVlKVxuICAgIHF1ZXJ5LmFkZERlc2NlbmRpbmcoJ191cGRhdGVkX2F0JylcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGNvbnN0IHN1cnZleXMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgc3VydmV5cy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiBzdXJ2ZXlzXG4gICAgfSlcbiAgfVxufVxuIl19