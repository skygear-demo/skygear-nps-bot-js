'use strict';

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const skygear = require('skygear');
const db = require('./db');
const Reply = require('./reply');

module.exports = class Survey {
  constructor(record) {
    this._record = record;
  }

  // create
  static get Record() {
    return skygear.Record.extend('survey');
  }

  static create(teamID, frequency, targetsID) {
    return _asyncToGenerator(function* () {
      const record = yield db.save(new Survey.Record({
        teamID,
        frequency,
        targetsID,
        isSent: false,
        isClosed: false
      }));
      return new Survey(record);
    })();
  }

  // read
  get updatedAt() {
    return this._record['updatedAt'];
  }

  get id() {
    return this._record['id'];
  }

  get teamID() {
    return this._record['teamID'];
  }

  get frequency() {
    return this._record['frequency'];
  }

  get targetsID() {
    return this._record['targetsID'];
  }

  get isSent() {
    return this._record['isSent'];
  }

  get isClosed() {
    return this._record['isClosed'];
  }

  static get weekly() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('frequency', 'weekly');
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      const surveys = [];
      for (let i = 0; i < result.length; i++) {
        surveys.push(new Survey(result[i]));
      }
      return surveys;
    });
  }

  static get monthly() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('frequency', 'monthly');
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      const surveys = [];
      for (let i = 0; i < result.length; i++) {
        surveys.push(new Survey(result[i]));
      }
      return surveys;
    });
  }

  static get quarterly() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('frequency', 'quarterly');
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      const surveys = [];
      for (let i = 0; i < result.length; i++) {
        surveys.push(new Survey(result[i]));
      }
      return surveys;
    });
  }

  // update
  set targetsID(newValue) {
    this._record['targetsID'] = newValue;
  }

  set isSent(newValue) {
    this._record['isSent'] = newValue;
  }

  set isClosed(newValue) {
    this._record['isClosed'] = newValue;
  }

  update() {
    var _this = this;

    return _asyncToGenerator(function* () {
      _this._record = yield db.save(_this._record);
    })();
  }

  // delete
  delete() {
    db.delete(this._record);
  }

  // misc

  // count both submitted and skipped
  get respondentsID() {
    const query = new skygear.Query(Reply.Record);
    query.equalTo('survey', new skygear.Reference(this._record));

    return db.query(query).then(result => {
      const respondents = [];
      for (let i = 0; i < result.length; i++) {
        respondents.push(result[i].userID);
      }
      return respondents;
    });
  }

  get stats() {
    const query = new skygear.Query(Reply.Record);
    query.equalTo('survey', new skygear.Reference(this._record));

    return db.query(query).then(result => {
      let sum = 0;
      let count = 0;
      for (let i = 0; i < result.length; i++) {
        const score = result[i].score;
        // submitted: number; skipped: null
        if (Number.isInteger(score)) {
          sum += score;
          count += 1;
        }
      }
      return {
        submissionCount: count,
        targetsCount: this.targetsID.length,
        responseRate: count / this.targetsID.length, // submitted / targets #,
        averageScore: sum / count // ignore skipped or silent targets
      };
    });
  }

  get replies() {
    const query = new skygear.Query(Reply.Record);
    query.equalTo('survey', new skygear.Reference(this._record));

    return db.query(query).then(result => {
      const replies = [];
      for (let i = 0; i < result.length; i++) {
        const reply = result[i];
        if (Number.isInteger(reply.score)) {
          replies.push({
            score: reply.score,
            reason: reply.reason
          });
        }
      }
      return replies;
    });
  }

  close() {
    this.isClosed = true;
    return this.update();
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXJ2ZXkuanMiXSwibmFtZXMiOlsic2t5Z2VhciIsInJlcXVpcmUiLCJkYiIsIlJlcGx5IiwibW9kdWxlIiwiZXhwb3J0cyIsIlN1cnZleSIsImNvbnN0cnVjdG9yIiwicmVjb3JkIiwiX3JlY29yZCIsIlJlY29yZCIsImV4dGVuZCIsImNyZWF0ZSIsInRlYW1JRCIsImZyZXF1ZW5jeSIsInRhcmdldHNJRCIsInNhdmUiLCJpc1NlbnQiLCJpc0Nsb3NlZCIsInVwZGF0ZWRBdCIsImlkIiwid2Vla2x5IiwicXVlcnkiLCJRdWVyeSIsImVxdWFsVG8iLCJ0aGVuIiwicmVzdWx0Iiwic3VydmV5cyIsImkiLCJsZW5ndGgiLCJwdXNoIiwibW9udGhseSIsInF1YXJ0ZXJseSIsIm5ld1ZhbHVlIiwidXBkYXRlIiwiZGVsZXRlIiwicmVzcG9uZGVudHNJRCIsIlJlZmVyZW5jZSIsInJlc3BvbmRlbnRzIiwidXNlcklEIiwic3RhdHMiLCJzdW0iLCJjb3VudCIsInNjb3JlIiwiTnVtYmVyIiwiaXNJbnRlZ2VyIiwic3VibWlzc2lvbkNvdW50IiwidGFyZ2V0c0NvdW50IiwicmVzcG9uc2VSYXRlIiwiYXZlcmFnZVNjb3JlIiwicmVwbGllcyIsInJlcGx5IiwicmVhc29uIiwiY2xvc2UiXSwibWFwcGluZ3MiOiI7Ozs7QUFBQSxNQUFNQSxVQUFVQyxRQUFRLFNBQVIsQ0FBaEI7QUFDQSxNQUFNQyxLQUFLRCxRQUFRLE1BQVIsQ0FBWDtBQUNBLE1BQU1FLFFBQVFGLFFBQVEsU0FBUixDQUFkOztBQUVBRyxPQUFPQyxPQUFQLEdBQWlCLE1BQU1DLE1BQU4sQ0FBYTtBQUM1QkMsY0FBYUMsTUFBYixFQUFxQjtBQUNuQixTQUFLQyxPQUFMLEdBQWVELE1BQWY7QUFDRDs7QUFFRDtBQUNBLGFBQVdFLE1BQVgsR0FBcUI7QUFDbkIsV0FBT1YsUUFBUVUsTUFBUixDQUFlQyxNQUFmLENBQXNCLFFBQXRCLENBQVA7QUFDRDs7QUFFRCxTQUFhQyxNQUFiLENBQXFC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QUFFQSxXQUFPUCxHQUFHb0IsS0FBSCxDQUFTQSxLQUFULEVBQWdCRyxJQUFoQixDQUFxQkMsVUFBVTtBQUNwQyxZQUFNd0IsVUFBVSxFQUFoQjtBQUNBLFdBQUssSUFBSXRCLElBQUksQ0FBYixFQUFnQkEsSUFBSUYsT0FBT0csTUFBM0IsRUFBbUNELEdBQW5DLEVBQXdDO0FBQ3RDLGNBQU11QixRQUFRekIsT0FBT0UsQ0FBUCxDQUFkO0FBQ0EsWUFBSWdCLE9BQU9DLFNBQVAsQ0FBaUJNLE1BQU1SLEtBQXZCLENBQUosRUFBbUM7QUFDakNPLGtCQUFRcEIsSUFBUixDQUFhO0FBQ1hhLG1CQUFPUSxNQUFNUixLQURGO0FBRVhTLG9CQUFRRCxNQUFNQztBQUZILFdBQWI7QUFJRDtBQUNGO0FBQ0QsYUFBT0YsT0FBUDtBQUNELEtBWk0sQ0FBUDtBQWFEOztBQUVERyxVQUFTO0FBQ1AsU0FBS25DLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQSxXQUFPLEtBQUtnQixNQUFMLEVBQVA7QUFDRDtBQTdLMkIsQ0FBOUIiLCJmaWxlIjoic3VydmV5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgc2t5Z2VhciA9IHJlcXVpcmUoJ3NreWdlYXInKVxuY29uc3QgZGIgPSByZXF1aXJlKCcuL2RiJylcbmNvbnN0IFJlcGx5ID0gcmVxdWlyZSgnLi9yZXBseScpXG5cbm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU3VydmV5IHtcbiAgY29uc3RydWN0b3IgKHJlY29yZCkge1xuICAgIHRoaXMuX3JlY29yZCA9IHJlY29yZFxuICB9XG5cbiAgLy8gY3JlYXRlXG4gIHN0YXRpYyBnZXQgUmVjb3JkICgpIHtcbiAgICByZXR1cm4gc2t5Z2Vhci5SZWNvcmQuZXh0ZW5kKCdzdXJ2ZXknKVxuICB9XG5cbiAgc3RhdGljIGFzeW5jIGNyZWF0ZSAodGVhbUlELCBmcmVxdWVuY3ksIHRhcmdldHNJRCkge1xuICAgIGNvbnN0IHJlY29yZCA9IGF3YWl0IGRiLnNhdmUobmV3IFN1cnZleS5SZWNvcmQoe1xuICAgICAgdGVhbUlELFxuICAgICAgZnJlcXVlbmN5LFxuICAgICAgdGFyZ2V0c0lELFxuICAgICAgaXNTZW50OiBmYWxzZSxcbiAgICAgIGlzQ2xvc2VkOiBmYWxzZVxuICAgIH0pKVxuICAgIHJldHVybiBuZXcgU3VydmV5KHJlY29yZClcbiAgfVxuXG4gIC8vIHJlYWRcbiAgZ2V0IHVwZGF0ZWRBdCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsndXBkYXRlZEF0J11cbiAgfVxuXG4gIGdldCBpZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaWQnXVxuICB9XG5cbiAgZ2V0IHRlYW1JRCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsndGVhbUlEJ11cbiAgfVxuXG4gIGdldCBmcmVxdWVuY3kgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2ZyZXF1ZW5jeSddXG4gIH1cblxuICBnZXQgdGFyZ2V0c0lEICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWyd0YXJnZXRzSUQnXVxuICB9XG5cbiAgZ2V0IGlzU2VudCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaXNTZW50J11cbiAgfVxuXG4gIGdldCBpc0Nsb3NlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaXNDbG9zZWQnXVxuICB9XG5cbiAgc3RhdGljIGdldCB3ZWVrbHkgKCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoU3VydmV5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdmcmVxdWVuY3knLCAnd2Vla2x5JylcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCBmYWxzZSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGNvbnN0IHN1cnZleXMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgc3VydmV5cy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiBzdXJ2ZXlzXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBnZXQgbW9udGhseSAoKSB7XG4gICAgY29uc3QgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2ZyZXF1ZW5jeScsICdtb250aGx5JylcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCBmYWxzZSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGNvbnN0IHN1cnZleXMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgc3VydmV5cy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiBzdXJ2ZXlzXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBnZXQgcXVhcnRlcmx5ICgpIHtcbiAgICBjb25zdCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnZnJlcXVlbmN5JywgJ3F1YXJ0ZXJseScpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNTZW50JywgZmFsc2UpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBjb25zdCBzdXJ2ZXlzID0gW11cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHN1cnZleXMucHVzaChuZXcgU3VydmV5KHJlc3VsdFtpXSkpXG4gICAgICB9XG4gICAgICByZXR1cm4gc3VydmV5c1xuICAgIH0pXG4gIH1cblxuICAvLyB1cGRhdGVcbiAgc2V0IHRhcmdldHNJRCAobmV3VmFsdWUpIHtcbiAgICB0aGlzLl9yZWNvcmRbJ3RhcmdldHNJRCddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHNldCBpc1NlbnQgKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWydpc1NlbnQnXSA9IG5ld1ZhbHVlXG4gIH1cblxuICBzZXQgaXNDbG9zZWQgKG5ld1ZhbHVlKSB7XG4gICAgdGhpcy5fcmVjb3JkWydpc0Nsb3NlZCddID0gbmV3VmFsdWVcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZSAoKSB7XG4gICAgdGhpcy5fcmVjb3JkID0gYXdhaXQgZGIuc2F2ZSh0aGlzLl9yZWNvcmQpXG4gIH1cblxuICAvLyBkZWxldGVcbiAgZGVsZXRlICgpIHtcbiAgICBkYi5kZWxldGUodGhpcy5fcmVjb3JkKVxuICB9XG5cbiAgLy8gbWlzY1xuXG4gIC8vIGNvdW50IGJvdGggc3VibWl0dGVkIGFuZCBza2lwcGVkXG4gIGdldCByZXNwb25kZW50c0lEICgpIHtcbiAgICBjb25zdCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFJlcGx5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdzdXJ2ZXknLCBuZXcgc2t5Z2Vhci5SZWZlcmVuY2UodGhpcy5fcmVjb3JkKSlcblxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uZGVudHMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgcmVzcG9uZGVudHMucHVzaChyZXN1bHRbaV0udXNlcklEKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHJlc3BvbmRlbnRzXG4gICAgfSlcbiAgfVxuXG4gIGdldCBzdGF0cyAoKSB7XG4gICAgY29uc3QgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShSZXBseS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnc3VydmV5JywgbmV3IHNreWdlYXIuUmVmZXJlbmNlKHRoaXMuX3JlY29yZCkpXG5cbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGxldCBzdW0gPSAwXG4gICAgICBsZXQgY291bnQgPSAwXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzY29yZSA9IHJlc3VsdFtpXS5zY29yZVxuICAgICAgICAvLyBzdWJtaXR0ZWQ6IG51bWJlcjsgc2tpcHBlZDogbnVsbFxuICAgICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihzY29yZSkpIHtcbiAgICAgICAgICBzdW0gKz0gc2NvcmVcbiAgICAgICAgICBjb3VudCArPSAxXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Ym1pc3Npb25Db3VudDogY291bnQsXG4gICAgICAgIHRhcmdldHNDb3VudDogdGhpcy50YXJnZXRzSUQubGVuZ3RoLFxuICAgICAgICByZXNwb25zZVJhdGU6IGNvdW50IC8gdGhpcy50YXJnZXRzSUQubGVuZ3RoLCAvLyBzdWJtaXR0ZWQgLyB0YXJnZXRzICMsXG4gICAgICAgIGF2ZXJhZ2VTY29yZTogc3VtIC8gY291bnQgLy8gaWdub3JlIHNraXBwZWQgb3Igc2lsZW50IHRhcmdldHNcbiAgICAgIH1cbiAgICB9KVxuICB9XG5cbiAgZ2V0IHJlcGxpZXMgKCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoUmVwbHkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ3N1cnZleScsIG5ldyBza3lnZWFyLlJlZmVyZW5jZSh0aGlzLl9yZWNvcmQpKVxuXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBjb25zdCByZXBsaWVzID0gW11cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHJlcGx5ID0gcmVzdWx0W2ldXG4gICAgICAgIGlmIChOdW1iZXIuaXNJbnRlZ2VyKHJlcGx5LnNjb3JlKSkge1xuICAgICAgICAgIHJlcGxpZXMucHVzaCh7XG4gICAgICAgICAgICBzY29yZTogcmVwbHkuc2NvcmUsXG4gICAgICAgICAgICByZWFzb246IHJlcGx5LnJlYXNvblxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiByZXBsaWVzXG4gICAgfSlcbiAgfVxuXG4gIGNsb3NlICgpIHtcbiAgICB0aGlzLmlzQ2xvc2VkID0gdHJ1ZVxuICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpXG4gIH1cbn1cbiJdfQ==