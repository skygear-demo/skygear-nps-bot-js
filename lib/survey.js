'use strict';

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const skygear = require('skygear');
const db = require('./db');
const Reply = require('./reply');

module.exports = class Survey {
  constructor(record) {
    this._record = record;
  }

  // create
  static get Record() {
    return skygear.Record.extend('survey');
  }

  static create(teamID, frequency, targetsID) {
    return _asyncToGenerator(function* () {
      const record = yield db.save(new Survey.Record({
        teamID,
        frequency,
        targetsID,
        distributionDate: new Date(),
        closingDate: new Date(),
        isSent: false,
        isClosed: false
      }));
      return new Survey(record);
    })();
  }

  // read
  get updatedAt() {
    return this._record['updatedAt'];
  }

  get id() {
    return this._record['id'];
  }

  get teamID() {
    return this._record['teamID'];
  }

  get frequency() {
    return this._record['frequency'];
  }

  get targetsID() {
    return this._record['targetsID'];
  }

  get distributionDate() {
    return this._record['distributionDate'];
  }

  get closingDate() {
    return this._record['closingDate'];
  }

  get isSent() {
    return this._record['isSent'];
  }

  get isClosed() {
    return this._record['isClosed'];
  }

  static of(id) {
    return _asyncToGenerator(function* () {
      const query = new skygear.Query(Survey.Record);
      query.equalTo('_id', id.substr(7)); // remove 'survey/' prefix

      const result = yield db.query(query);
      if (result.length > 1) {
        throw new Error(`Mutiple surveys with identical id ${id} found`);
      }
      return result[0] ? new Survey(result[0]) : null;
    })();
  }

  static get weekly() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('frequency', 'weekly');
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      const surveys = [];
      for (let i = 0; i < result.length; i++) {
        surveys.push(new Survey(result[i]));
      }
      return surveys;
    });
  }

  static get monthly() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('frequency', 'monthly');
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      const surveys = [];
      for (let i = 0; i < result.length; i++) {
        surveys.push(new Survey(result[i]));
      }
      return surveys;
    });
  }

  static get quarterly() {
    const query = new skygear.Query(Survey.Record);
    query.equalTo('frequency', 'quarterly');
    query.equalTo('isSent', false);
    return db.query(query).then(result => {
      const surveys = [];
      for (let i = 0; i < result.length; i++) {
        surveys.push(new Survey(result[i]));
      }
      return surveys;
    });
  }

  // update
  set targetsID(newValue) {
    this._record['targetsID'] = newValue;
  }

  set distributionDate(newValue) {
    this._record['distributionDate'] = newValue;
  }

  set closingDate(newValue) {
    this._record['closingDate'] = newValue;
  }

  set isSent(newValue) {
    this._record['isSent'] = newValue;
  }

  set isClosed(newValue) {
    this._record['isClosed'] = newValue;
  }

  update() {
    var _this = this;

    return _asyncToGenerator(function* () {
      _this._record = yield db.save(_this._record);
    })();
  }

  // delete
  delete() {
    db.delete(this._record);
  }

  // misc

  // count both submitted and skipped
  get respondentsID() {
    const query = new skygear.Query(Reply.Record);
    query.equalTo('survey', new skygear.Reference(this._record));

    return db.query(query).then(result => {
      const respondents = [];
      for (let i = 0; i < result.length; i++) {
        respondents.push(result[i].userID);
      }
      return respondents;
    });
  }

  get stats() {
    const query = new skygear.Query(Reply.Record);
    query.equalTo('survey', new skygear.Reference(this._record));

    return db.query(query).then(result => {
      let sum = 0;
      let count = 0;
      let scoresCount = Array(10).fill(0);
      for (let i = 0; i < result.length; i++) {
        const score = result[i].score;
        // submitted: number; skipped: null
        if (Number.isInteger(score)) {
          sum += score;
          count += 1;
          scoresCount[score - 1] += 1;
        }
      }
      return {
        submissionCount: count,
        targetsCount: this.targetsID.length,
        responseRate: count / this.targetsID.length, // submitted / targets #,
        averageScore: sum / count, // ignore skipped or silent targets
        scoresCount
      };
    });
  }

  get replies() {
    const query = new skygear.Query(Reply.Record);
    query.equalTo('survey', new skygear.Reference(this._record));

    return db.query(query).then(result => {
      const replies = [];
      for (let i = 0; i < result.length; i++) {
        const reply = result[i];
        if (Number.isInteger(reply.score)) {
          replies.push({
            score: reply.score,
            reason: reply.reason
          });
        }
      }
      return replies;
    });
  }

  close() {
    this.isClosed = true;
    this.closingDate = new Date();
    return this.update();
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdXJ2ZXkuanMiXSwibmFtZXMiOlsic2t5Z2VhciIsInJlcXVpcmUiLCJkYiIsIlJlcGx5IiwibW9kdWxlIiwiZXhwb3J0cyIsIlN1cnZleSIsImNvbnN0cnVjdG9yIiwicmVjb3JkIiwiX3JlY29yZCIsIlJlY29yZCIsImV4dGVuZCIsImNyZWF0ZSIsInRlYW1JRCIsImZyZXF1ZW5jeSIsInRhcmdldHNJRCIsInNhdmUiLCJkaXN0cmlidXRpb25EYXRlIiwiRGF0ZSIsImNsb3NpbmdEYXRlIiwiaXNTZW50IiwiaXNDbG9zZWQiLCJ1cGRhdGVkQXQiLCJpZCIsIm9mIiwicXVlcnkiLCJRdWVyeSIsImVxdWFsVG8iLCJzdWJzdHIiLCJyZXN1bHQiLCJsZW5ndGgiLCJFcnJvciIsIndlZWtseSIsInRoZW4iLCJzdXJ2ZXlzIiwiaSIsInB1c2giLCJtb250aGx5IiwicXVhcnRlcmx5IiwibmV3VmFsdWUiLCJ1cGRhdGUiLCJkZWxldGUiLCJyZXNwb25kZW50c0lEIiwiUmVmZXJlbmNlIiwicmVzcG9uZGVudHMiLCJ1c2VySUQiLCJzdGF0cyIsInN1bSIsImNvdW50Iiwic2NvcmVzQ291bnQiLCJBcnJheSIsImZpbGwiLCJzY29yZSIsIk51bWJlciIsImlzSW50ZWdlciIsInN1Ym1pc3Npb25Db3VudCIsInRhcmdldHNDb3VudCIsInJlc3BvbnNlUmF0ZSIsImF2ZXJhZ2VTY29yZSIsInJlcGxpZXMiLCJyZXBseSIsInJlYXNvbiIsImNsb3NlIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsTUFBTUEsVUFBVUMsUUFBUSxTQUFSLENBQWhCO0FBQ0EsTUFBTUMsS0FBS0QsUUFBUSxNQUFSLENBQVg7QUFDQSxNQUFNRSxRQUFRRixRQUFRLFNBQVIsQ0FBZDs7QUFFQUcsT0FBT0MsT0FBUCxHQUFpQixNQUFNQyxNQUFOLENBQWE7QUFDNUJDLGNBQWFDLE1BQWIsRUFBcUI7QUFDbkIsU0FBS0MsT0FBTCxHQUFlRCxNQUFmO0FBQ0Q7O0FBRUQ7QUFDQSxhQUFX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ZSxVQUFNRSxPQUFOLENBQWMsUUFBZCxFQUF3QixJQUFJM0IsUUFBUTJDLFNBQVosQ0FBc0IsS0FBS2xDLE9BQTNCLENBQXhCOztBQUVBLFdBQU9QLEdBQUd1QixLQUFILENBQVNBLEtBQVQsRUFBZ0JRLElBQWhCLENBQXFCSixVQUFVO0FBQ3BDLFlBQU04QixVQUFVLEVBQWhCO0FBQ0EsV0FBSyxJQUFJeEIsSUFBSSxDQUFiLEVBQWdCQSxJQUFJTixPQUFPQyxNQUEzQixFQUFtQ0ssR0FBbkMsRUFBd0M7QUFDdEMsY0FBTXlCLFFBQVEvQixPQUFPTSxDQUFQLENBQWQ7QUFDQSxZQUFJa0IsT0FBT0MsU0FBUCxDQUFpQk0sTUFBTVIsS0FBdkIsQ0FBSixFQUFtQztBQUNqQ08sa0JBQVF2QixJQUFSLENBQWE7QUFDWGdCLG1CQUFPUSxNQUFNUixLQURGO0FBRVhTLG9CQUFRRCxNQUFNQztBQUZILFdBQWI7QUFJRDtBQUNGO0FBQ0QsYUFBT0YsT0FBUDtBQUNELEtBWk0sQ0FBUDtBQWFEOztBQUVERyxVQUFTO0FBQ1AsU0FBS3pDLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQSxTQUFLRixXQUFMLEdBQW1CLElBQUlELElBQUosRUFBbkI7QUFDQSxXQUFPLEtBQUtzQixNQUFMLEVBQVA7QUFDRDtBQTlNMkIsQ0FBOUIiLCJmaWxlIjoic3VydmV5LmpzIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3Qgc2t5Z2VhciA9IHJlcXVpcmUoJ3NreWdlYXInKVxuY29uc3QgZGIgPSByZXF1aXJlKCcuL2RiJylcbmNvbnN0IFJlcGx5ID0gcmVxdWlyZSgnLi9yZXBseScpXG5cbm1vZHVsZS5leHBvcnRzID0gY2xhc3MgU3VydmV5IHtcbiAgY29uc3RydWN0b3IgKHJlY29yZCkge1xuICAgIHRoaXMuX3JlY29yZCA9IHJlY29yZFxuICB9XG5cbiAgLy8gY3JlYXRlXG4gIHN0YXRpYyBnZXQgUmVjb3JkICgpIHtcbiAgICByZXR1cm4gc2t5Z2Vhci5SZWNvcmQuZXh0ZW5kKCdzdXJ2ZXknKVxuICB9XG5cbiAgc3RhdGljIGFzeW5jIGNyZWF0ZSAodGVhbUlELCBmcmVxdWVuY3ksIHRhcmdldHNJRCkge1xuICAgIGNvbnN0IHJlY29yZCA9IGF3YWl0IGRiLnNhdmUobmV3IFN1cnZleS5SZWNvcmQoe1xuICAgICAgdGVhbUlELFxuICAgICAgZnJlcXVlbmN5LFxuICAgICAgdGFyZ2V0c0lELFxuICAgICAgZGlzdHJpYnV0aW9uRGF0ZTogbmV3IERhdGUoKSxcbiAgICAgIGNsb3NpbmdEYXRlOiBuZXcgRGF0ZSgpLFxuICAgICAgaXNTZW50OiBmYWxzZSxcbiAgICAgIGlzQ2xvc2VkOiBmYWxzZVxuICAgIH0pKVxuICAgIHJldHVybiBuZXcgU3VydmV5KHJlY29yZClcbiAgfVxuXG4gIC8vIHJlYWRcbiAgZ2V0IHVwZGF0ZWRBdCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsndXBkYXRlZEF0J11cbiAgfVxuXG4gIGdldCBpZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsnaWQnXVxuICB9XG5cbiAgZ2V0IHRlYW1JRCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3JlY29yZFsndGVhbUlEJ11cbiAgfVxuXG4gIGdldCBmcmVxdWVuY3kgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2ZyZXF1ZW5jeSddXG4gIH1cblxuICBnZXQgdGFyZ2V0c0lEICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWyd0YXJnZXRzSUQnXVxuICB9XG5cbiAgZ2V0IGRpc3RyaWJ1dGlvbkRhdGUgKCkge1xuICAgIHJldHVybiB0aGlzLl9yZWNvcmRbJ2Rpc3RyaWJ1dGlvbkRhdGUnXVxuICB9XG5cbiAgZ2V0IGNsb3NpbmdEYXRlICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydjbG9zaW5nRGF0ZSddXG4gIH1cblxuICBnZXQgaXNTZW50ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydpc1NlbnQnXVxuICB9XG5cbiAgZ2V0IGlzQ2xvc2VkICgpIHtcbiAgICByZXR1cm4gdGhpcy5fcmVjb3JkWydpc0Nsb3NlZCddXG4gIH1cblxuICBzdGF0aWMgYXN5bmMgb2YgKGlkKSB7XG4gICAgY29uc3QgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ19pZCcsIGlkLnN1YnN0cig3KSkgLy8gcmVtb3ZlICdzdXJ2ZXkvJyBwcmVmaXhcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRiLnF1ZXJ5KHF1ZXJ5KVxuICAgIGlmIChyZXN1bHQubGVuZ3RoID4gMSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNdXRpcGxlIHN1cnZleXMgd2l0aCBpZGVudGljYWwgaWQgJHtpZH0gZm91bmRgKVxuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0WzBdID8gbmV3IFN1cnZleShyZXN1bHRbMF0pIDogbnVsbFxuICB9XG5cbiAgc3RhdGljIGdldCB3ZWVrbHkgKCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoU3VydmV5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdmcmVxdWVuY3knLCAnd2Vla2x5JylcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCBmYWxzZSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGNvbnN0IHN1cnZleXMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgc3VydmV5cy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiBzdXJ2ZXlzXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBnZXQgbW9udGhseSAoKSB7XG4gICAgY29uc3QgcXVlcnkgPSBuZXcgc2t5Z2Vhci5RdWVyeShTdXJ2ZXkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ2ZyZXF1ZW5jeScsICdtb250aGx5JylcbiAgICBxdWVyeS5lcXVhbFRvKCdpc1NlbnQnLCBmYWxzZSlcbiAgICByZXR1cm4gZGIucXVlcnkocXVlcnkpLnRoZW4ocmVzdWx0ID0+IHtcbiAgICAgIGNvbnN0IHN1cnZleXMgPSBbXVxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgc3VydmV5cy5wdXNoKG5ldyBTdXJ2ZXkocmVzdWx0W2ldKSlcbiAgICAgIH1cbiAgICAgIHJldHVybiBzdXJ2ZXlzXG4gICAgfSlcbiAgfVxuXG4gIHN0YXRpYyBnZXQgcXVhcnRlcmx5ICgpIHtcbiAgICBjb25zdCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFN1cnZleS5SZWNvcmQpXG4gICAgcXVlcnkuZXF1YWxUbygnZnJlcXVlbmN5JywgJ3F1YXJ0ZXJseScpXG4gICAgcXVlcnkuZXF1YWxUbygnaXNTZW50JywgZmFsc2UpXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBjb25zdCBzdXJ2ZXlzID0gW11cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHN1cnZleXMucHVzaChuZXcgU3VydmV5KHJlc3VsdFtpXSkpXG4gICAgICB9XG4gICAgICByZXR1cm4gc3VydmV5c1xuICAgIH0pXG4gIH1cblxuICAvLyB1cGRhdGVcbiAgc2V0IHRhcmdldHNJRCAobmV3VmFsdWUpIHtcbiAgICB0aGlzLl9yZWNvcmRbJ3RhcmdldHNJRCddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHNldCBkaXN0cmlidXRpb25EYXRlIChuZXdWYWx1ZSkge1xuICAgIHRoaXMuX3JlY29yZFsnZGlzdHJpYnV0aW9uRGF0ZSddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHNldCBjbG9zaW5nRGF0ZSAobmV3VmFsdWUpIHtcbiAgICB0aGlzLl9yZWNvcmRbJ2Nsb3NpbmdEYXRlJ10gPSBuZXdWYWx1ZVxuICB9XG5cbiAgc2V0IGlzU2VudCAobmV3VmFsdWUpIHtcbiAgICB0aGlzLl9yZWNvcmRbJ2lzU2VudCddID0gbmV3VmFsdWVcbiAgfVxuXG4gIHNldCBpc0Nsb3NlZCAobmV3VmFsdWUpIHtcbiAgICB0aGlzLl9yZWNvcmRbJ2lzQ2xvc2VkJ10gPSBuZXdWYWx1ZVxuICB9XG5cbiAgYXN5bmMgdXBkYXRlICgpIHtcbiAgICB0aGlzLl9yZWNvcmQgPSBhd2FpdCBkYi5zYXZlKHRoaXMuX3JlY29yZClcbiAgfVxuXG4gIC8vIGRlbGV0ZVxuICBkZWxldGUgKCkge1xuICAgIGRiLmRlbGV0ZSh0aGlzLl9yZWNvcmQpXG4gIH1cblxuICAvLyBtaXNjXG5cbiAgLy8gY291bnQgYm90aCBzdWJtaXR0ZWQgYW5kIHNraXBwZWRcbiAgZ2V0IHJlc3BvbmRlbnRzSUQgKCkge1xuICAgIGNvbnN0IHF1ZXJ5ID0gbmV3IHNreWdlYXIuUXVlcnkoUmVwbHkuUmVjb3JkKVxuICAgIHF1ZXJ5LmVxdWFsVG8oJ3N1cnZleScsIG5ldyBza3lnZWFyLlJlZmVyZW5jZSh0aGlzLl9yZWNvcmQpKVxuXG4gICAgcmV0dXJuIGRiLnF1ZXJ5KHF1ZXJ5KS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBjb25zdCByZXNwb25kZW50cyA9IFtdXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICByZXNwb25kZW50cy5wdXNoKHJlc3VsdFtpXS51c2VySUQpXG4gICAgICB9XG4gICAgICByZXR1cm4gcmVzcG9uZGVudHNcbiAgICB9KVxuICB9XG5cbiAgZ2V0IHN0YXRzICgpIHtcbiAgICBjb25zdCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFJlcGx5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdzdXJ2ZXknLCBuZXcgc2t5Z2Vhci5SZWZlcmVuY2UodGhpcy5fcmVjb3JkKSlcblxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgbGV0IHN1bSA9IDBcbiAgICAgIGxldCBjb3VudCA9IDBcbiAgICAgIGxldCBzY29yZXNDb3VudCA9IEFycmF5KDEwKS5maWxsKDApXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzY29yZSA9IHJlc3VsdFtpXS5zY29yZVxuICAgICAgICAvLyBzdWJtaXR0ZWQ6IG51bWJlcjsgc2tpcHBlZDogbnVsbFxuICAgICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihzY29yZSkpIHtcbiAgICAgICAgICBzdW0gKz0gc2NvcmVcbiAgICAgICAgICBjb3VudCArPSAxXG4gICAgICAgICAgc2NvcmVzQ291bnRbc2NvcmUgLSAxXSArPSAxXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Ym1pc3Npb25Db3VudDogY291bnQsXG4gICAgICAgIHRhcmdldHNDb3VudDogdGhpcy50YXJnZXRzSUQubGVuZ3RoLFxuICAgICAgICByZXNwb25zZVJhdGU6IGNvdW50IC8gdGhpcy50YXJnZXRzSUQubGVuZ3RoLCAvLyBzdWJtaXR0ZWQgLyB0YXJnZXRzICMsXG4gICAgICAgIGF2ZXJhZ2VTY29yZTogc3VtIC8gY291bnQsIC8vIGlnbm9yZSBza2lwcGVkIG9yIHNpbGVudCB0YXJnZXRzXG4gICAgICAgIHNjb3Jlc0NvdW50XG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGdldCByZXBsaWVzICgpIHtcbiAgICBjb25zdCBxdWVyeSA9IG5ldyBza3lnZWFyLlF1ZXJ5KFJlcGx5LlJlY29yZClcbiAgICBxdWVyeS5lcXVhbFRvKCdzdXJ2ZXknLCBuZXcgc2t5Z2Vhci5SZWZlcmVuY2UodGhpcy5fcmVjb3JkKSlcblxuICAgIHJldHVybiBkYi5xdWVyeShxdWVyeSkudGhlbihyZXN1bHQgPT4ge1xuICAgICAgY29uc3QgcmVwbGllcyA9IFtdXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCByZXBseSA9IHJlc3VsdFtpXVxuICAgICAgICBpZiAoTnVtYmVyLmlzSW50ZWdlcihyZXBseS5zY29yZSkpIHtcbiAgICAgICAgICByZXBsaWVzLnB1c2goe1xuICAgICAgICAgICAgc2NvcmU6IHJlcGx5LnNjb3JlLFxuICAgICAgICAgICAgcmVhc29uOiByZXBseS5yZWFzb25cbiAgICAgICAgICB9KVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gcmVwbGllc1xuICAgIH0pXG4gIH1cblxuICBjbG9zZSAoKSB7XG4gICAgdGhpcy5pc0Nsb3NlZCA9IHRydWVcbiAgICB0aGlzLmNsb3NpbmdEYXRlID0gbmV3IERhdGUoKVxuICAgIHJldHVybiB0aGlzLnVwZGF0ZSgpXG4gIH1cbn1cbiJdfQ==